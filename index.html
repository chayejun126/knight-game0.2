<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë‚˜ì´íŠ¸ íˆ¬ì–´ í¼ì¦</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f0f0f0; padding: 30px; }
    h1 { margin-bottom: 5px; }
    #successCount, #timer { font-size: 18px; margin-bottom: 15px; color: #444; }
    .board { display: grid; gap: 4px; justify-content: center; margin-top: 10px; }
    .cell {
      background-color: white; border: 1px solid #333; display: flex;
      justify-content: center; align-items: center; font-size: 24px;
      cursor: pointer; user-select: none; width: 60px; height: 60px;
    }
    .visited { background-color: #d0e0ff; }
    .knight { font-size: 28px; }
    #message { margin-top: 20px; font-size: 18px; color: green; }
    .menu button, #resetBtn, #openRankingBtn {
      padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer;
    }
    #resetBtn { display: none; }
    #ranking { text-align: left; margin: 20px auto; width: max-content; }
    #rankingList { padding-left: 20px; margin: 0; }
  </style>
</head>
<body>
  <h1>â™ ë‚˜ì´íŠ¸ íˆ¬ì–´ í¼ì¦</h1>
  <div id="successCount">ì„±ê³µ: 0</div>
  <div id="timer">ì‹œê°„: 0.00ì´ˆ</div>
  <div id="ranking">
    <h2>ğŸ† ë­í‚¹ (ìƒìœ„ 5)</h2>
    <ol id="rankingList"></ol>
  </div>
  <!-- ë­í‚¹ íŒì—… ì—´ê¸° ë²„íŠ¼ -->
  <button id="openRankingBtn">ë­í‚¹ ë³´ê¸°</button>
  <div id="menu" class="menu">
    <p>ë³´ë“œ í¬ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”:</p>
    <button onclick="startGame(5)">5x5</button>
    <button onclick="startGame(6)">6x6</button>
    <button onclick="startGame(7)">7x7</button>
  </div>
  <div class="board" id="board"></div>
  <div id="message"></div>
  <button id="resetBtn" onclick="resetGame()">ë‹¤ì‹œ ì‹œì‘</button>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxfBF01E6UdHjugtUtyRmK46MDX5JDtR7LpgVi1Vr0UY8fQsf-hJYXNY9F-SN1svQN1/exec'; // Apps Script ì›¹ì•± URLë¡œ ë³€ê²½í•˜ì„¸ìš”

    let boardSize = 5;
    let knightPos = null;
    let visited = [];
    let successCount = 0;
    let gameEnded = false;
    let startTime = null;
    let timerInterval = null;

    const board = document.getElementById('board');
    const message = document.getElementById('message');
    const resetBtn = document.getElementById('resetBtn');
    const menu = document.getElementById('menu');
    const successDisplay = document.getElementById('successCount');
    const timerDisplay = document.getElementById('timer');
    const openRankingBtn = document.getElementById('openRankingBtn');

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë­í‚¹ í‘œì‹œ ë° íŒì—… ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
    window.addEventListener('load', () => {
      displayRanking();
      openRankingBtn.addEventListener('click', openRankingPopup);
    });

    function startGame(size) {
      boardSize = size;
      menu.style.display = 'none';
      resetBtn.style.display = 'inline-block';
      createBoard();
      displayRanking();
    }

    function createBoard() {
      board.innerHTML = '';
      visited = [];
      knightPos = null;
      gameEnded = false;
      clearInterval(timerInterval);
      startTime = null;
      timerDisplay.textContent = 'ì‹œê°„: 0.00ì´ˆ';
      board.style.gridTemplateColumns = `repeat(${boardSize},60px)`;
      board.style.gridTemplateRows = `repeat(${boardSize},60px)`;
      for (let y = 0; y < boardSize; y++) {
        for (let x = 0; x < boardSize; x++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.x = x;
          cell.dataset.y = y;
          cell.addEventListener('click', handleClick);
          board.appendChild(cell);
        }
      }
      message.textContent = 'ì‹œì‘í•  ì¹¸ì„ ì„ íƒí•˜ì„¸ìš”.';
    }

    async function handleClick(e) {
      if (gameEnded) return;
      const x = +e.target.dataset.x;
      const y = +e.target.dataset.y;
      const idx = y * boardSize + x;

      // ì²« í´ë¦­: ì‹œì‘ ìœ„ì¹˜ ì„¤ì •
      if (!knightPos) {
        knightPos = { x, y };
        visited.push(idx);
        startTime = Date.now();
        timerInterval = setInterval(() => {
          const elapsed = (Date.now() - startTime) / 1000;
          timerDisplay.textContent = `ì‹œê°„: ${elapsed.toFixed(2)}ì´ˆ`;
        }, 100);
        updateBoard();
        message.textContent = 'ì´ì œ ë‚˜ì´íŠ¸ì˜ ì´ë™ìœ¼ë¡œ ì§„í–‰í•˜ì„¸ìš”!';
        return;
      }

      const dx = Math.abs(knightPos.x - x);
      const dy = Math.abs(knightPos.y - y);
      const isValid = (dx === 2 && dy === 1) || (dx === 1 && dy === 2);
      const alreadyVisited = visited.includes(idx);

      if (isValid && !alreadyVisited) {
        knightPos = { x, y };
        visited.push(idx);
        updateBoard();
        if (visited.length === boardSize * boardSize) {
          clearInterval(timerInterval);
          const elapsed = Date.now() - startTime;
          message.textContent = 'ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  ì¹¸ì„ ë°©ë¬¸í–ˆìŠµë‹ˆë‹¤!';
          successCount++;
          successDisplay.textContent = `ì„±ê³µ: ${successCount}`;
          gameEnded = true;
          await saveScore(elapsed);
        }
      } else {
        message.textContent = alreadyVisited ? 'ì´ë¯¸ ë°©ë¬¸í•œ ì¹¸ì…ë‹ˆë‹¤.' : 'ë‚˜ì´íŠ¸ ì›€ì§ì„ì´ ì•„ë‹™ë‹ˆë‹¤!';
      }
    }

    function updateBoard() {
      const cells = document.querySelectorAll('.cell');
      cells.forEach((cell, i) => {
        cell.classList.remove('knight', 'visited');
        if (visited.includes(i)) cell.classList.add('visited');
      });
      if (knightPos) {
        const idx = knightPos.y * boardSize + knightPos.x;
        const cell = cells[idx];
        cell.textContent = 'â™';
        cell.classList.add('knight');
      }
    }

    function resetGame() {
      clearInterval(timerInterval);
      menu.style.display = 'block';
      resetBtn.style.display = 'none';
      board.innerHTML = '';
      message.textContent = '';
      gameEnded = false;
      timerDisplay.textContent = 'ì‹œê°„: 0.00ì´ˆ';
      displayRanking();
    }

    function displayRanking() {
      fetch(`${WEB_APP_URL}?limit=5`)
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById('rankingList');
          list.innerHTML = '';
          data.forEach(item => {
            const li = document.createElement('li');
            li.textContent = `${item.name}: ${(item.time/1000).toFixed(2)}ì´ˆ`;
            list.appendChild(li);
          });
        })
        .catch(console.error);
    }

    // ë­í‚¹ íŒì—… ì—´ê¸°
    function openRankingPopup() {
      const popup = window.open('', 'ë­í‚¹', 'width=400,height=600');
      popup.document.write(`<!DOCTYPE html>
        <html lang="ko">
        <head><meta charset="UTF-8"><title>ì „ì²´ ë­í‚¹</title></head>
        <body>
          <h1>ğŸ† ì „ì²´ ë­í‚¹</h1>
          <ol id="popupRanking"></ol>
          <script>
            fetch('${WEB_APP_URL}')
              .then(res => res.json())
              .then(data => {
                const list = document.getElementById('popupRanking');
                data.forEach(item => {
                  const li = document.createElement('li');
                  li.textContent = item.name + ': ' + (item.time/1000).toFixed(2) + 'ì´ˆ';
                  list.appendChild(li);
                });
              })
              .catch(console.error);
          <\/script>
        </body>
        </html>
      `);
    }

    async function saveScore(elapsed) {
      const name = prompt('ë­í‚¹ì— ë“±ë¡í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', '');
      const playerName = name || 'ìµëª…';
      await fetch(WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: playerName, time: elapsed })
      });
      displayRanking();
    }
  </script>
</body>
</html>
