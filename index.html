<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>나이트 투어 퍼즐</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f0f0f0; padding: 30px; }
    h1 { margin-bottom: 5px; }
    #successCount, #timer { font-size: 18px; margin-bottom: 15px; color: #444; }
    .board { display: grid; gap: 4px; justify-content: center; margin-top: 10px; }
    .cell {
      background-color: white; border: 1px solid #333; display: flex;
      justify-content: center; align-items: center; font-size: 24px;
      cursor: pointer; user-select: none; width: 60px; height: 60px;
    }
    .visited { background-color: #d0e0ff; }
    .knight { font-size: 28px; }
    #message { margin-top: 20px; font-size: 18px; color: green; }
    .menu button, #resetBtn, #openRankingBtn {
      padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer;
    }
    #resetBtn { display: none; }
    #ranking { text-align: left; margin: 20px auto; width: max-content; }
    #rankingList { padding-left: 20px; margin: 0; }
  </style>
</head>
<body>
  <h1>♞ 나이트 투어 퍼즐</h1>
  <div id="successCount">성공: 0</div>
  <div id="timer">시간: 0.00초</div>
  <div id="ranking">
    <h2>🏆 랭킹 (상위 5)</h2>
    <ol id="rankingList"></ol>
  </div>
  <!-- 랭킹 팝업 열기 버튼 -->
  <button id="openRankingBtn">랭킹 보기</button>
  <div id="menu" class="menu">
    <p>보드 크기를 선택하세요:</p>
    <button onclick="startGame(5)">5x5</button>
    <button onclick="startGame(6)">6x6</button>
    <button onclick="startGame(7)">7x7</button>
  </div>
  <div class="board" id="board"></div>
  <div id="message"></div>
  <button id="resetBtn" onclick="resetGame()">다시 시작</button>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxfBF01E6UdHjugtUtyRmK46MDX5JDtR7LpgVi1Vr0UY8fQsf-hJYXNY9F-SN1svQN1/exec'; // Apps Script 웹앱 URL로 변경하세요

    let boardSize = 5;
    let knightPos = null;
    let visited = [];
    let successCount = 0;
    let gameEnded = false;
    let startTime = null;
    let timerInterval = null;

    const board = document.getElementById('board');
    const message = document.getElementById('message');
    const resetBtn = document.getElementById('resetBtn');
    const menu = document.getElementById('menu');
    const successDisplay = document.getElementById('successCount');
    const timerDisplay = document.getElementById('timer');
    const openRankingBtn = document.getElementById('openRankingBtn');

    // 페이지 로드 시 랭킹 표시 및 팝업 버튼 이벤트 연결
    window.addEventListener('load', () => {
      displayRanking();
      openRankingBtn.addEventListener('click', openRankingPopup);
    });

    function startGame(size) {
      boardSize = size;
      menu.style.display = 'none';
      resetBtn.style.display = 'inline-block';
      createBoard();
      displayRanking();
    }

    function createBoard() {
      board.innerHTML = '';
      visited = [];
      knightPos = null;
      gameEnded = false;
      clearInterval(timerInterval);
      startTime = null;
      timerDisplay.textContent = '시간: 0.00초';
      board.style.gridTemplateColumns = `repeat(${boardSize},60px)`;
      board.style.gridTemplateRows = `repeat(${boardSize},60px)`;
      for (let y = 0; y < boardSize; y++) {
        for (let x = 0; x < boardSize; x++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.x = x;
          cell.dataset.y = y;
          cell.addEventListener('click', handleClick);
          board.appendChild(cell);
        }
      }
      message.textContent = '시작할 칸을 선택하세요.';
    }

    async function handleClick(e) {
      if (gameEnded) return;
      const x = +e.target.dataset.x;
      const y = +e.target.dataset.y;
      const idx = y * boardSize + x;

      // 첫 클릭: 시작 위치 설정
      if (!knightPos) {
        knightPos = { x, y };
        visited.push(idx);
        startTime = Date.now();
        timerInterval = setInterval(() => {
          const elapsed = (Date.now() - startTime) / 1000;
          timerDisplay.textContent = `시간: ${elapsed.toFixed(2)}초`;
        }, 100);
        updateBoard();
        message.textContent = '이제 나이트의 이동으로 진행하세요!';
        return;
      }

      const dx = Math.abs(knightPos.x - x);
      const dy = Math.abs(knightPos.y - y);
      const isValid = (dx === 2 && dy === 1) || (dx === 1 && dy === 2);
      const alreadyVisited = visited.includes(idx);

      if (isValid && !alreadyVisited) {
        knightPos = { x, y };
        visited.push(idx);
        updateBoard();
        if (visited.length === boardSize * boardSize) {
          clearInterval(timerInterval);
          const elapsed = Date.now() - startTime;
          message.textContent = '🎉 축하합니다! 모든 칸을 방문했습니다!';
          successCount++;
          successDisplay.textContent = `성공: ${successCount}`;
          gameEnded = true;
          await saveScore(elapsed);
        }
      } else {
        message.textContent = alreadyVisited ? '이미 방문한 칸입니다.' : '나이트 움직임이 아닙니다!';
      }
    }

    function updateBoard() {
      const cells = document.querySelectorAll('.cell');
      cells.forEach((cell, i) => {
        cell.classList.remove('knight', 'visited');
        if (visited.includes(i)) cell.classList.add('visited');
      });
      if (knightPos) {
        const idx = knightPos.y * boardSize + knightPos.x;
        const cell = cells[idx];
        cell.textContent = '♞';
        cell.classList.add('knight');
      }
    }

    function resetGame() {
      clearInterval(timerInterval);
      menu.style.display = 'block';
      resetBtn.style.display = 'none';
      board.innerHTML = '';
      message.textContent = '';
      gameEnded = false;
      timerDisplay.textContent = '시간: 0.00초';
      displayRanking();
    }

    function displayRanking() {
      fetch(`${WEB_APP_URL}?limit=5`)
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById('rankingList');
          list.innerHTML = '';
          data.forEach(item => {
            const li = document.createElement('li');
            li.textContent = `${item.name}: ${(item.time/1000).toFixed(2)}초`;
            list.appendChild(li);
          });
        })
        .catch(console.error);
    }

    // 랭킹 팝업 열기
    function openRankingPopup() {
      const popup = window.open('', '랭킹', 'width=400,height=600');
      popup.document.write(`<!DOCTYPE html>
        <html lang="ko">
        <head><meta charset="UTF-8"><title>전체 랭킹</title></head>
        <body>
          <h1>🏆 전체 랭킹</h1>
          <ol id="popupRanking"></ol>
          <script>
            fetch('${WEB_APP_URL}')
              .then(res => res.json())
              .then(data => {
                const list = document.getElementById('popupRanking');
                data.forEach(item => {
                  const li = document.createElement('li');
                  li.textContent = item.name + ': ' + (item.time/1000).toFixed(2) + '초';
                  list.appendChild(li);
                });
              })
              .catch(console.error);
          <\/script>
        </body>
        </html>
      `);
    }

    async function saveScore(elapsed) {
      const name = prompt('랭킹에 등록할 이름을 입력하세요:', '');
      const playerName = name || '익명';
      await fetch(WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: playerName, time: elapsed })
      });
      displayRanking();
    }
  </script>
</body>
</html>
